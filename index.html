<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SisMD â€” Sistem Merentas Desa</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/src/style.css">
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo" onclick="bukaAdmin()" style="cursor:pointer;" title="Admin">Sis<em>MD</em></div>
  <div class="nav">
    <button class="nb active" onclick="gp('daftar',this)">ğŸ“ <span>Daftar</span></button>
    <button class="nb" onclick="gp('kawalan',this)">ğŸ <span>Kawalan</span></button>
    <button class="nb" onclick="gp('scan',this)">ğŸ“· <span>Scan</span></button>
    <button class="nb" onclick="gp('keputusan',this)">ğŸ† <span>Keputusan</span></button>
  </div>
</div>
<div id="toast"></div>

<!-- ================================================================ -->
<!-- PAGE: DAFTAR (DEFAULT) -->
<!-- ================================================================ -->
<div class="page active" id="page-daftar">
  <div class="ph">Pendaftaran Peserta</div>
  <div class="ps">Masukkan kod sekolah untuk semak atau daftar peserta.</div>

  <!-- Step 0: School code lookup -->
  <div class="card" id="d-lookup-form" style="margin-bottom:16px; max-width:520px;">
    <div class="cl">ğŸ« Kod Sekolah</div>
    <div class="fl">
      <div>
        <label class="lbl">Masukkan Kod Sekolah</label>
        <input class="inp" id="d-lookup-kod" placeholder="PBB1013" maxlength="20"
          oninput="this.value=this.value.toUpperCase()"
          onkeydown="if(event.key==='Enter')semakSekolahDaftar()">
      </div>
      <button class="btn btn-green btn-full" onclick="semakSekolahDaftar()">Semak &amp; Teruskan â†’</button>
    </div>
  </div>

  <!-- Step 1: New school name (hidden until lookup finds no match) -->
  <div class="card" id="daftar-skl-form" style="display:none; margin-bottom:16px; max-width:520px;">
    <div class="cl">ğŸ« Daftar Sekolah Baru</div>
    <div style="font-size:0.78rem; color:var(--ink2); margin-bottom:12px;">Kod sekolah ini belum wujud dalam sistem. Sila masukkan nama sekolah untuk mendaftar.</div>
    <div class="fl">
      <div>
        <label class="lbl">Kod Sekolah</label>
        <input class="inp" id="d-kod" placeholder="PBB1013" maxlength="20"
          oninput="this.value=this.value.toUpperCase()"
          onkeydown="if(event.key==='Enter')document.getElementById('d-nama').focus()">
      </div>
      <div>
        <label class="lbl">Nama Sekolah</label>
        <input class="inp" id="d-nama" placeholder="SK TAMAN MAJU" maxlength="80"
          oninput="this.value=this.value.toUpperCase()"
          onkeydown="if(event.key==='Enter')simpanSekolah()">
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-ghost" onclick="tukarSekolah()">â† Semak Semula</button>
        <button class="btn btn-green" style="flex:1;" onclick="simpanSekolah()">Teruskan â†’ Daftar Peserta</button>
      </div>
    </div>
  </div>

  <!-- Step 2: Student form (hidden until school confirmed) -->
  <div id="daftar-murid-form" style="display:none;">
    <div class="card" style="margin-bottom:16px; max-width:520px;">
      <div class="cl" style="justify-content:space-between; flex-wrap:wrap; gap:6px;">
        <span>â• Daftar Peserta</span>
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <span id="d-skl-badge" class="badge bg-x" style="font-size:0.72rem;"></span>
          <button class="btn btn-sm btn-ghost" onclick="tukarSekolah()">âœï¸ Tukar Sekolah</button>
        </div>
      </div>

      <!-- Registration closed message -->
      <div id="reg-closed-msg" style="display:none;" class="alert al-a">
        ğŸ”’ Pendaftaran ditutup oleh admin. Tiada penambahan atau pemadaman dibenarkan.
      </div>

      <!-- Add form (hidden when registration closed) -->
      <div id="daftar-add-form">
        <!-- Category selector -->
        <div style="display:flex; gap:10px; margin-bottom:14px;">
          <label class="kat-btn" style="flex:1;">
            <input type="radio" name="d-kat" value="L12" checked style="display:none;">
            <span class="kat-lbl" data-kat="L12">ğŸ”µ L12 â€” Lelaki</span>
          </label>
          <label class="kat-btn" style="flex:1;">
            <input type="radio" name="d-kat" value="P12" style="display:none;">
            <span class="kat-lbl" data-kat="P12">ğŸŸ£ P12 â€” Perempuan</span>
          </label>
        </div>

        <div class="fl">
          <div>
            <label class="lbl">Nama Penuh</label>
            <input class="inp" id="d-mnama" placeholder="Nama peserta" autocomplete="off"
              onkeydown="if(event.key==='Enter')document.getElementById('d-mic').focus()">
          </div>
          <div>
            <label class="lbl">No. IC (12 digit, tanpa sempang)</label>
            <input class="inp" id="d-mic" placeholder="120105101234" maxlength="12"
              inputmode="numeric" autocomplete="off"
              onkeydown="if(event.key==='Enter')daftarPeserta()">
            <div style="font-size:0.71rem; color:var(--ink3); margin-top:4px;">Digit terakhir ganjil = Lelaki Â· Genap = Perempuan</div>
          </div>
          <button class="btn btn-green btn-full" onclick="daftarPeserta()">âœ… Daftar Peserta Ini</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Participant list -->
  <div class="card">
    <div class="cl" style="justify-content:space-between;">
      <span>ğŸ“‹ Senarai Peserta Berdaftar</span>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <span id="jml" class="badge bg-x">0 peserta</span>
        <button class="btn btn-sm btn-ghost" onclick="cetakBIB()">ğŸ–¨ Cetak BIB</button>
        <button class="btn btn-sm btn-ghost" onclick="eksportSenarai()">ğŸ“¥ Eksport</button>
        <button class="btn btn-sm btn-ghost" style="color:var(--accent2);" onclick="tanyaReset()">ğŸ—‘ Reset</button>
      </div>
    </div>
    <div class="ftabs" id="murid-ftabs">
      <button class="ftab active" onclick="fd('semua',this)">Semua</button>
      <button class="ftab" onclick="fd('L12',this)">L12</button>
      <button class="ftab" onclick="fd('P12',this)">P12</button>
    </div>
    <input class="inp" id="cari-inp" placeholder="ğŸ” Cari nama atau IC..." oninput="renderMurid()" style="margin-bottom:12px;">
    <div class="tw">
      <table>
        <thead><tr><th>No. Series</th><th>Nama</th><th>IC</th><th>Sekolah</th><th>Kod</th><th>Kat.</th><th>Status</th><th></th></tr></thead>
        <tbody id="tb-murid"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ================================================================ -->
<!-- PAGE: KAWALAN -->
<!-- ================================================================ -->
<div class="page" id="page-kawalan">
  <div class="ph">Kawalan Larian</div>
  <div class="ps">Operator garisan mula tekan butang MULA untuk setiap kategori. Masa dikira dari saat butang ditekan (Gun Time).</div>
  <div class="alert al-a">âš ï¸ Pastikan semua peserta sudah bersedia di garisan mula sebelum tekan MULA. Masa tidak boleh diundur.</div>
  <div class="g2">
    <div class="cat-card" id="cc-L12">
      <div class="cat-big L12">L12</div>
      <div class="cat-st" id="cs-L12">Belum bermula</div>
      <div class="cat-tm" id="ct-L12">--:--:--</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button class="btn btn-blue btn-full btn-lg" id="bm-L12" onclick="mula('L12')">ğŸ MULA L12</button>
        <button class="btn btn-red btn-full" id="bt-L12" onclick="tamat('L12')" disabled>â¹ Tamat Larian L12</button>
      </div>
      <div class="cat-mi" id="cm-L12"></div>
    </div>
    <div class="cat-card" id="cc-P12">
      <div class="cat-big P12">P12</div>
      <div class="cat-st" id="cs-P12">Belum bermula</div>
      <div class="cat-tm" id="ct-P12">--:--:--</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button class="btn btn-full btn-lg" id="bm-P12" onclick="mula('P12')" style="background:var(--purple);color:#fff;">ğŸ MULA P12</button>
        <button class="btn btn-red btn-full" id="bt-P12" onclick="tamat('P12')" disabled>â¹ Tamat Larian P12</button>
      </div>
      <div class="cat-mi" id="cm-P12"></div>
    </div>
  </div>
  <div class="card" style="margin-top:14px;">
    <div class="cl">ğŸ“‹ Log Aktiviti</div>
    <div class="log-box" id="log">Sistem sedia. Menunggu arahan...</div>
  </div>
</div>

<!-- ================================================================ -->
<!-- PAGE: SCAN -->
<!-- ================================================================ -->
<div class="page" id="page-scan">
  <div class="ph">Scan Garisan Penamat</div>
  <div class="ps">Gunakan kamera AI (Gemini) atau taip manual nombor bib peserta yang telah tamat larian.</div>
  <div id="scan-bar" class="alert al-a">âš ï¸ Tiada larian aktif. Mulakan larian di halaman Kawalan dahulu.</div>
  <div class="scan-shell">
    <div class="scan-head">
      <div class="scan-ht">IMBAS NOMBOR BIB</div>
      <div class="cam-wrap" id="cam-wrap">
        <video id="camv" autoplay playsinline muted></video>
        <div class="cam-ov"><div class="cam-fr"><div class="sl"></div></div></div>
      </div>
      <div class="ai-st"><div class="ai-dot" id="aid"></div><span id="ait">Kamera tidak aktif</span></div>
      <div class="cam-btns">
        <button class="btn btn-blue" id="btn-cam" onclick="toggleCam()">ğŸ“· Buka Kamera AI</button>
        <button class="btn btn-green" id="btn-cap" onclick="tangkap()" style="display:none;">âš¡ Tangkap &amp; Scan AI</button>
        <button class="btn btn-ghost btn-sm" id="btn-stopc" onclick="stopCam()" style="display:none; color:#fafaf8; border-color:rgba(255,255,255,0.2);">âœ• Tutup</button>
      </div>
      <div id="confirm-panel" style="display:none; background:rgba(82,183,136,0.12); border:1.5px solid #52b788; border-radius:10px; padding:14px; margin:12px 0; text-align:center;">
        <div style="font-size:0.72rem; color:rgba(250,250,248,0.5); margin-bottom:6px; text-transform:uppercase; letter-spacing:1px;">AI detect â€” sahkan sebelum rekod</div>
        <div style="font-size:0.82rem; color:rgba(250,250,248,0.7); margin-bottom:8px;">Nama: <strong id="confirm-nama-disp" style="color:#fafaf8;"></strong></div>
        <input class="bib-inp" id="confirm-nombor" maxlength="10" oninput="this.value=this.value.toUpperCase()" style="text-align:center; margin-bottom:10px; font-size:1.4rem; letter-spacing:4px;">
        <div style="display:flex; gap:8px; justify-content:center;">
          <button class="btn btn-ghost btn-sm" onclick="batalPending()" style="color:#fafaf8; border-color:rgba(255,255,255,0.2);">âœ• Batal</button>
          <button class="btn btn-green" onclick="sahkan()">âœ… Sahkan &amp; Rekod</button>
        </div>
      </div>
      <div style="font-size:0.7rem; color:rgba(250,250,248,0.25); letter-spacing:1px; margin-bottom:10px;">â€” ATAU TAIP MANUAL â€”</div>
      <div class="bib-row">
        <input class="bib-inp" id="bib-inp" placeholder="L0045" maxlength="10"
          oninput="this.value=this.value.toUpperCase()"
          onkeydown="if(event.key==='Enter')proses(this.value)">
        <button class="btn btn-green" onclick="proses(document.getElementById('bib-inp').value)" style="padding:12px 16px;font-size:1.1rem;">â†’</button>
      </div>
      <div class="scan-res-wrap">
        <div class="sres" id="sres">
          <div class="sres-name" id="sres-name"></div>
          <div class="sres-meta" id="sres-meta"></div>
          <div class="sres-tm" id="sres-tm"></div>
        </div>
      </div>
    </div>
    <div class="scan-foot">
      <div class="cl" style="justify-content:space-between; margin-bottom:10px;">
        <span>ğŸ• Baru Direkod</span>
        <span id="scnt" class="badge bg-g">0</span>
      </div>
      <div class="tw">
        <table>
          <thead><tr><th>#</th><th>Nama</th><th>Kat</th><th>Tempoh</th><th>Masa Tamat</th></tr></thead>
          <tbody id="tb-scan"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ================================================================ -->
<!-- PAGE: KEPUTUSAN -->
<!-- ================================================================ -->
<div class="page" id="page-keputusan">
  <div class="ph">Keputusan &amp; Ranking</div>
  <div class="ps">Papan pendahulu dikemaskini setiap kali peserta direkod.</div>
  <div class="chips">
    <div class="chip"><div class="cv" id="st-tot">0</div><div class="ck">Jumlah Tamat</div></div>
    <div class="chip"><div class="cv" id="st-l">0</div><div class="ck">L12 Tamat</div></div>
    <div class="chip"><div class="cv" id="st-p">0</div><div class="ck">P12 Tamat</div></div>
    <div class="chip"><div class="cv" id="st-d">0</div><div class="ck">Berdaftar</div></div>
  </div>
  <div class="ftabs">
    <button class="ftab active" onclick="flb('semua',this)">Semua</button>
    <button class="ftab" onclick="flb('L12',this)">ğŸ”µ L12</button>
    <button class="ftab" onclick="flb('P12',this)">ğŸŸ£ P12</button>
  </div>
  <div class="card" style="padding:0; overflow:hidden;">
    <div class="lbh"><div>#</div><div>Peserta</div><div>Sekolah</div><div>Tempoh</div><div>No. Series</div></div>
    <div id="lb-body"></div>
  </div>
  <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
    <button class="btn btn-ghost" onclick="eksportCSV()">ğŸ“¥ Eksport CSV</button>
    <button class="btn btn-ghost" onclick="window.print()">ğŸ–¨ Cetak / PDF</button>
  </div>
</div>

<!-- BIB PRINT AREA -->
<div id="bib-print-area" class="bib-print-area"></div>

<!-- ================================================================ -->
<!-- MODAL: ADMIN -->
<!-- ================================================================ -->
<div class="modal-bg" id="modal-admin">
  <div class="modal" style="max-width:520px;">
    <h3>ğŸ” Admin SisMD</h3>

    <!-- Login form -->
    <div id="adm-login">
      <p style="margin:0 0 14px; font-size:0.82rem; color:var(--ink2);">Masukkan kata laluan untuk akses panel admin.</p>
      <input class="inp" id="adm-pass" type="password" placeholder="Kata laluan admin"
        onkeydown="if(event.key==='Enter')loginAdmin()" style="margin-bottom:12px;">
      <div class="ma">
        <button class="btn btn-ghost" onclick="tutupAdmin()">Batal</button>
        <button class="btn btn-green" onclick="loginAdmin()">Log Masuk</button>
      </div>
    </div>

    <!-- Admin panel -->
    <div id="adm-panel" style="display:none;">

      <!-- Accordion: Registration Status -->
      <div class="acc-section">
        <button class="acc-hdr" onclick="toggleAcc('acc-reg')">ğŸ”’ Status Pendaftaran</button>
        <div class="acc-body" id="acc-reg" style="display:none;">
          <div id="adm-reg-status" style="margin-bottom:10px; font-size:0.82rem;"></div>
          <button id="btn-toggle-reg" class="btn btn-red btn-sm" onclick="toggleReg()">ğŸ”’ Tutup Pendaftaran</button>
        </div>
      </div>

      <!-- Accordion: Full Participant List -->
      <div class="acc-section">
        <button class="acc-hdr" onclick="toggleAcc('acc-peserta')">ğŸ“‹ Senarai Peserta Berdaftar</button>
        <div class="acc-body" id="acc-peserta" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:6px;">
            <span id="adm-jml" class="badge bg-x">0 peserta</span>
            <button class="btn btn-sm btn-ghost" onclick="eksportAdminCSV()">ğŸ“¥ Eksport CSV</button>
          </div>
          <div class="tw">
            <table>
              <thead><tr><th>No. Series</th><th>Nama</th><th>IC</th><th>Sekolah</th><th>Kat.</th><th>Status</th><th></th></tr></thead>
              <tbody id="tb-adm-peserta"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Accordion: Gemini API Key -->
      <div class="acc-section">
        <button class="acc-hdr" onclick="toggleAcc('acc-gemini')">ğŸ”‘ Kunci API Gemini</button>
        <div class="acc-body" id="acc-gemini" style="display:none;">
          <p style="font-size:0.78rem; color:var(--ink2); margin-bottom:8px;">Digunakan untuk scan BIB dengan kamera AI. Disimpan di Firebase.</p>
          <input class="inp" id="adm-gemini" type="password" placeholder="AIza..." style="margin-bottom:8px;">
          <button class="btn btn-green btn-sm" onclick="simpanGeminiKey()">Simpan Kunci Gemini</button>
        </div>
      </div>

      <!-- Accordion: Google Sheets URL -->
      <div class="acc-section">
        <button class="acc-hdr" onclick="toggleAcc('acc-gs')">ğŸ“Š URL Google Sheets</button>
        <div class="acc-body" id="acc-gs" style="display:none;">
          <p style="font-size:0.78rem; color:var(--ink2); margin-bottom:8px;">URL Apps Script untuk hantar keputusan ke Google Sheets. Disimpan di Firebase.</p>
          <input class="inp" id="adm-gs" type="text" placeholder="https://script.google.com/macros/s/..." style="margin-bottom:8px;">
          <button class="btn btn-green btn-sm" onclick="simpanGSUrl()">Simpan URL Sheets</button>
        </div>
      </div>

      <!-- Accordion: Reset Data -->
      <div class="acc-section">
        <button class="acc-hdr" style="color:var(--accent2);" onclick="toggleAcc('acc-reset')">ğŸ—‘ï¸ Reset Data Firebase</button>
        <div class="acc-body" id="acc-reset" style="display:none;">
          <p style="font-size:0.78rem; color:var(--accent2); margin-bottom:10px;">âš ï¸ Ini akan memadam SEMUA peserta, rekod larian dan keputusan dari Firebase. Tidak boleh dibatalkan.</p>
          <button class="btn btn-red btn-sm" onclick="doReset(); tutupAdmin();">Ya, Reset Semua Data</button>
        </div>
      </div>

      <div class="ma" style="margin-top:16px; padding-top:14px; border-top:1px solid var(--border);">
        <button class="btn btn-ghost btn-sm" style="color:var(--ink2); font-size:0.75rem;" onclick="logoutAdmin()">Log Keluar Admin</button>
        <button class="btn btn-ghost" onclick="tutupAdmin()">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL RESET -->
<div class="modal-bg" id="modal-reset">
  <div class="modal">
    <h3>âš ï¸ Reset Semua Data?</h3>
    <p>Ini akan memadam SEMUA peserta, rekod larian dan keputusan. Tidak boleh dibatalkan.</p>
    <div class="ma">
      <button class="btn btn-ghost" onclick="tutupModal()">Batal</button>
      <button class="btn btn-red" onclick="doReset()">Ya, Reset</button>
    </div>
  </div>
</div>

<script type="module" src="/src/main.js"></script>
</body>
</html>
