<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SisMD â€” Sistem Merentas Desa</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/src/style.css">
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo">Sis<em>MD</em></div>
  <div class="nav">
    <button class="nb active" onclick="gp('daftar',this)">ğŸ“ <span>Daftar</span></button>
    <button class="nb" onclick="gp('semak',this)">ğŸ« <span>Semak</span></button>
    <button class="nb" onclick="gp('kawalan',this)">ğŸ <span>Kawalan</span></button>
    <button class="nb" onclick="gp('scan',this)">ğŸ“· <span>Scan</span></button>
    <button class="nb" onclick="gp('keputusan',this)">ğŸ† <span>Keputusan</span></button>
  </div>
</div>
<div id="toast"></div>

<!-- ================================================================ -->
<!-- PAGE: DAFTAR -->
<!-- ================================================================ -->
<div class="page active" id="page-daftar">
  <div class="ph">Pendaftaran Peserta</div>
  <div class="ps">Muat turun template CSV â†’ isi maklumat peserta â†’ upload semula. Sistem akan jana nombor series secara automatik.</div>

  <div class="steps" style="margin-bottom:24px;">
    <div class="step active" id="step1">
      <div class="step-dot active">1</div>
      <div class="step-label">Muat Turun Template</div>
    </div>
    <div class="step" id="step2">
      <div class="step-dot">2</div>
      <div class="step-label">Isi &amp; Upload CSV</div>
    </div>
    <div class="step" id="step3">
      <div class="step-dot">3</div>
      <div class="step-label">Semak &amp; Sahkan</div>
    </div>
  </div>

  <div class="g2" style="margin-bottom:16px;">
    <div class="card">
      <div class="cl">ğŸ“„ Langkah 1 â€” Muat Turun Template CSV</div>
      <div style="background:var(--surface2); border-radius:8px; padding:14px; font-family:'JetBrains Mono',monospace; font-size:0.75rem; color:var(--ink2); line-height:1.9; margin-bottom:14px; border:1px solid var(--border);">
        <span style="color:var(--ink); font-weight:600;">Nama,IC,Sekolah,Kod_Sekolah,Kategori,Jantina</span><br>
        Amirul Aiman,120105101234,SK Taman Maju,PBB1013,L12,Lelaki<br>
        Siti Aishah,120205201111,SK Sri Aman,PBB1013,P12,Perempuan<br>
        <span style="color:var(--ink3);"># Kategori: L12 atau P12</span><br>
        <span style="color:var(--ink3);"># Jantina: Lelaki atau Perempuan</span>
      </div>
      <button class="btn btn-dark btn-full" onclick="turunTemplate()">â¬‡ Muat Turun Template CSV</button>
    </div>

    <div class="card">
      <div class="cl">ğŸ“‚ Langkah 2 â€” Upload CSV Yang Telah Diisi</div>
      <div class="upload-zone" id="uz" ondragover="dragOn(event)" ondragleave="dragOff()" ondrop="dropFile(event)">
        <input type="file" accept=".csv" id="csv-file" onchange="bacaCSV(event)">
        <div class="upload-icon">ğŸ“‹</div>
        <div class="upload-title">Drag &amp; drop CSV di sini</div>
        <div class="upload-sub">atau klik untuk pilih fail</div>
      </div>
      <div id="upload-info" style="display:none; margin-top:10px;" class="alert al-g"></div>
    </div>
  </div>

  <div class="card" id="preview-card" style="display:none;">
    <div class="cl" style="justify-content:space-between;">
      <span>ğŸ‘ Langkah 3 â€” Semak &amp; Sahkan Import</span>
      <button class="btn btn-sm btn-ghost" onclick="clearPreview()">âœ• Batal</button>
    </div>
    <div class="import-summary" id="imp-summary"></div>
    <div id="dup-warn" style="display:none; margin-bottom:12px;" class="alert al-r">
      âš ï¸ <span id="dup-warn-txt"></span>
    </div>
    <div class="ftabs">
      <button class="ftab active" onclick="fprev('semua',this)">Semua</button>
      <button class="ftab" onclick="fprev('baru',this)">âœ… Baru</button>
      <button class="ftab" onclick="fprev('dup',this)">âš ï¸ Duplikat</button>
    </div>
    <div class="preview-wrap">
      <table>
        <thead><tr><th>Status</th><th>Nama</th><th>IC</th><th>Sekolah</th><th>Kod Sekolah</th><th>Kategori</th><th>Jantina</th></tr></thead>
        <tbody id="tb-prev"></tbody>
      </table>
    </div>
    <div style="display:flex; gap:10px; margin-top:14px; justify-content:flex-end; flex-wrap:wrap;">
      <button class="btn btn-ghost" onclick="clearPreview()">Batal</button>
      <button class="btn btn-red btn-sm" onclick="importHanya('baru')" id="btn-skip-dup" style="display:none;">Import Baru Sahaja (Abaikan Duplikat)</button>
      <button class="btn btn-green btn-lg" onclick="importSemua()" id="btn-import-all">âœ… Sahkan &amp; Import Semua</button>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="cl" style="justify-content:space-between;">
      <span>ğŸ“‹ Senarai Peserta Berdaftar</span>
      <div style="display:flex; gap:8px; align-items:center;">
        <span id="jml" class="badge bg-x">0 peserta</span>
        <button class="btn btn-sm btn-ghost" onclick="eksportSenarai()">ğŸ“¥ Eksport</button>
        <button class="btn btn-sm btn-ghost" style="color:var(--accent2);" onclick="tanyaReset()">ğŸ—‘ Reset</button>
      </div>
    </div>
    <div class="ftabs">
      <button class="ftab active" onclick="fd('semua',this)">Semua</button>
      <button class="ftab" onclick="fd('L12',this)">L12</button>
      <button class="ftab" onclick="fd('P12',this)">P12</button>
    </div>
    <input class="inp" id="cari-inp" placeholder="ğŸ” Cari nama, IC, sekolah atau kod sekolah..." oninput="renderMurid()" style="margin-bottom:12px;">
    <div class="tw">
      <table>
        <thead><tr><th>No. Series</th><th>Nama</th><th>IC</th><th>Sekolah</th><th>Kod</th><th>Kategori</th><th>Status Larian</th><th></th></tr></thead>
        <tbody id="tb-murid"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ================================================================ -->
<!-- PAGE: SEMAK SEKOLAH -->
<!-- ================================================================ -->
<div class="page" id="page-semak">
  <div class="ph">Semak Penyertaan Sekolah</div>
  <div class="ps">Guru boleh masukkan kod sekolah untuk semak senarai peserta dan status larian mereka.</div>
  <div class="lookup-box">
    <div class="lookup-title">MASUKKAN KOD SEKOLAH</div>
    <div style="font-size:0.78rem; color:rgba(216,243,220,0.35); margin-bottom:16px;">cth: PBB1013</div>
    <div class="lookup-row">
      <input class="lookup-inp" id="kod-inp" placeholder="PBB1013" maxlength="12"
        oninput="this.value=this.value.toUpperCase()"
        onkeydown="if(event.key==='Enter')semakSekolah()">
      <button class="btn btn-green btn-lg" onclick="semakSekolah()">Semak â†’</button>
    </div>
    <div id="lookup-result" class="lookup-result" style="display:none;"></div>
  </div>
  <div class="card" id="lookup-table-card" style="display:none; margin-top:16px;">
    <div class="cl" style="justify-content:space-between;">
      <span id="lookup-card-title">Senarai Peserta</span>
      <button class="btn btn-sm btn-ghost" onclick="eksportSekolah()">ğŸ“¥ Eksport CSV</button>
    </div>
    <div class="tw">
      <table>
        <thead><tr><th>No. Series</th><th>Nama</th><th>IC</th><th>Kategori</th><th>Status Larian</th><th>Ranking</th><th>Masa</th></tr></thead>
        <tbody id="tb-lookup"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ================================================================ -->
<!-- PAGE: KAWALAN -->
<!-- ================================================================ -->
<div class="page" id="page-kawalan">
  <div class="ph">Kawalan Larian</div>
  <div class="ps">Operator garisan mula tekan butang MULA untuk setiap kategori. Masa dikira dari saat butang ditekan (Gun Time).</div>
  <div class="alert al-a">âš ï¸ Pastikan semua peserta sudah bersedia di garisan mula sebelum tekan MULA. Masa tidak boleh diundur.</div>
  <div class="g2">
    <div class="cat-card" id="cc-L12">
      <div class="cat-big L12">L12</div>
      <div class="cat-st" id="cs-L12">Belum bermula</div>
      <div class="cat-tm" id="ct-L12">--:--:--</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button class="btn btn-blue btn-full btn-lg" id="bm-L12" onclick="mula('L12')">ğŸ MULA L12</button>
        <button class="btn btn-red btn-full" id="bt-L12" onclick="tamat('L12')" disabled>â¹ Tamat Larian L12</button>
      </div>
      <div class="cat-mi" id="cm-L12"></div>
    </div>
    <div class="cat-card" id="cc-P12">
      <div class="cat-big P12">P12</div>
      <div class="cat-st" id="cs-P12">Belum bermula</div>
      <div class="cat-tm" id="ct-P12">--:--:--</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button class="btn btn-full btn-lg" id="bm-P12" onclick="mula('P12')" style="background:var(--purple);color:#fff;">ğŸ MULA P12</button>
        <button class="btn btn-red btn-full" id="bt-P12" onclick="tamat('P12')" disabled>â¹ Tamat Larian P12</button>
      </div>
      <div class="cat-mi" id="cm-P12"></div>
    </div>
  </div>
  <div class="card" style="margin-top:14px;">
    <div class="cl">ğŸ“‹ Log Aktiviti</div>
    <div class="log-box" id="log">Sistem sedia. Menunggu arahan...</div>
  </div>
</div>

<!-- ================================================================ -->
<!-- PAGE: SCAN -->
<!-- ================================================================ -->
<div class="page" id="page-scan">
  <div class="ph">Scan Garisan Penamat</div>
  <div class="ps">Gunakan kamera AI atau taip manual nombor bib peserta yang telah tamat larian.</div>
  <div class="apibar">
    <div style="font-size:0.75rem; font-weight:700; color:var(--blue); text-transform:uppercase; letter-spacing:1px;">ğŸ¤– Claude AI Vision</div>
    <div style="font-size:0.75rem; color:var(--ink2); margin-top:3px; margin-bottom:8px;">Masukkan Anthropic API key untuk aktifkan kamera AI. Key disimpan dalam browser sahaja.</div>
    <div class="api-row">
      <input class="api-inp" id="ak-inp" type="password" placeholder="sk-ant-api03-...">
      <button class="btn btn-sm btn-ghost" onclick="simpanAK()">Simpan</button>
      <button class="btn btn-sm btn-ghost" onclick="toggleAK()">ğŸ‘</button>
    </div>
    <div id="ak-st" style="font-size:0.7rem; margin-top:5px; color:var(--ink2);"></div>
  </div>
  <div id="scan-bar" class="alert al-a">âš ï¸ Tiada larian aktif. Mulakan larian di halaman Kawalan dahulu.</div>
  <div class="scan-shell">
    <div class="scan-head">
      <div class="scan-ht">IMBAS NOMBOR BIB</div>
      <div class="cam-wrap" id="cam-wrap">
        <video id="camv" autoplay playsinline muted></video>
        <div class="cam-ov"><div class="cam-fr"><div class="sl"></div></div></div>
      </div>
      <div class="ai-st"><div class="ai-dot" id="aid"></div><span id="ait">Kamera tidak aktif</span></div>
      <div class="cam-btns">
        <button class="btn btn-blue" id="btn-cam" onclick="toggleCam()">ğŸ“· Buka Kamera AI</button>
        <button class="btn btn-green" id="btn-cap" onclick="tangkap()" style="display:none;">âš¡ Tangkap &amp; Scan AI</button>
        <button class="btn btn-ghost btn-sm" id="btn-stopc" onclick="stopCam()" style="display:none; color:#fafaf8; border-color:rgba(255,255,255,0.2);">âœ• Tutup</button>
      </div>
      <div style="font-size:0.7rem; color:rgba(250,250,248,0.25); letter-spacing:1px; margin-bottom:10px;">â€” ATAU TAIP MANUAL â€”</div>
      <div class="bib-row">
        <input class="bib-inp" id="bib-inp" placeholder="L120045" maxlength="10"
          oninput="this.value=this.value.toUpperCase()"
          onkeydown="if(event.key==='Enter')proses(this.value)">
        <button class="btn btn-green" onclick="proses(document.getElementById('bib-inp').value)" style="padding:12px 16px;font-size:1.1rem;">â†’</button>
      </div>
      <div class="scan-res-wrap">
        <div class="sres" id="sres">
          <div class="sres-name" id="sres-name"></div>
          <div class="sres-meta" id="sres-meta"></div>
          <div class="sres-tm" id="sres-tm"></div>
        </div>
      </div>
    </div>
    <div class="scan-foot">
      <div class="cl" style="justify-content:space-between; margin-bottom:10px;">
        <span>ğŸ• Baru Direkod</span>
        <span id="scnt" class="badge bg-g">0</span>
      </div>
      <div class="tw">
        <table>
          <thead><tr><th>#</th><th>Nama</th><th>Kat</th><th>Tempoh</th><th>Masa Tamat</th></tr></thead>
          <tbody id="tb-scan"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ================================================================ -->
<!-- PAGE: KEPUTUSAN -->
<!-- ================================================================ -->
<div class="page" id="page-keputusan">
  <div class="ph">Keputusan &amp; Ranking</div>
  <div class="ps">Papan pendahulu dikemaskini setiap kali peserta direkod.</div>
  <div class="chips">
    <div class="chip"><div class="cv" id="st-tot">0</div><div class="ck">Jumlah Tamat</div></div>
    <div class="chip"><div class="cv" id="st-l">0</div><div class="ck">L12 Tamat</div></div>
    <div class="chip"><div class="cv" id="st-p">0</div><div class="ck">P12 Tamat</div></div>
    <div class="chip"><div class="cv" id="st-d">0</div><div class="ck">Berdaftar</div></div>
  </div>
  <div class="ftabs">
    <button class="ftab active" onclick="flb('semua',this)">Semua</button>
    <button class="ftab" onclick="flb('L12',this)">ğŸ”µ L12</button>
    <button class="ftab" onclick="flb('P12',this)">ğŸŸ£ P12</button>
  </div>
  <div class="card" style="padding:0; overflow:hidden;">
    <div class="lbh"><div>#</div><div>Peserta</div><div>Sekolah</div><div>Tempoh</div><div>No. Series</div></div>
    <div id="lb-body"></div>
  </div>
  <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
    <button class="btn btn-ghost" onclick="eksportCSV()">ğŸ“¥ Eksport CSV</button>
    <button class="btn btn-ghost" onclick="window.print()">ğŸ–¨ Cetak / PDF</button>
  </div>
</div>

<!-- MODAL RESET -->
<div class="modal-bg" id="modal-reset">
  <div class="modal">
    <h3>âš ï¸ Reset Semua Data?</h3>
    <p>Ini akan memadam SEMUA peserta, rekod larian dan keputusan. Tidak boleh dibatalkan.</p>
    <div class="ma">
      <button class="btn btn-ghost" onclick="tutupModal()">Batal</button>
      <button class="btn btn-red" onclick="doReset()">Ya, Reset</button>
    </div>
  </div>
</div>

<script type="module" src="/src/main.js"></script>
</body>
</html>
